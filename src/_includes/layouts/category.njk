{% extends "layouts/base.njk" %}

{% block head %}
<style>
/* Category Search Enhancements */
#category-search-autocomplete {
  scrollbar-width: thin;
  scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
}

#category-search-autocomplete::-webkit-scrollbar {
  width: 8px;
}

#category-search-autocomplete::-webkit-scrollbar-track {
  background: transparent;
}

#category-search-autocomplete::-webkit-scrollbar-thumb {
  background-color: rgba(0, 0, 0, 0.2);
  border-radius: 4px;
}

.search-result:first-child {
  border-radius: 6px 6px 0 0;
}

.search-result:last-child {
  border-radius: 0 0 6px 6px;
}

/* Search bar green background */
.bg-green-50 {
  background-color: #f0fdf4;
}
</style>
{% endblock %}

{% block body %}
<section class="py-16 ~px-4/8 bg-[#E92429]/20">
  <div class="container m-auto max-w-3xl lg:px-48">
    <!-- Header -->
    <div class="mb-8 mt-16">
      <h1 class="text-3xl font-bold mb-2">{{ name }}</h1>
      <nav class="text-sm text-gray-600">
        <a href="/" class="hover:text-[#E92429]">Hlavní stránka</a>
        <span class="mx-2">»</span>
        <a href="/cs/katalog" class="hover:text-[#E92429]">Katalog</a>
        <span class="mx-2">»</span>
        <span>{{ name }}</span>
      </nav>
    </div>

    {% set categoryProducts = collections.products | categoryProducts(name) %}
    
    {% if categoryProducts | length > 0 %}
    <!-- Category Search -->
    <div class="mb-8">
      <div class="relative max-w-2xl">
        <label for="category-search" class="sr-only">Vyhledat v kategorii {{ name }}</label>
        
        <!-- Search Bar with Icon, Input, and Button -->
        <div class="flex items-center gap-2 bg-green-50 rounded-xl p-2" data-search-scope="category" data-category-name="{{ name }}">
          <!-- Magnifier Icon Box -->
          <div class="flex-shrink-0 w-10 h-10 md:w-12 md:h-12 bg-white rounded-lg flex items-center justify-center">
            <svg class="w-5 h-5 md:w-6 md:h-6 text-[#00A44F]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
          </div>
          
          <!-- Input Field (with autocomplete dropdown) -->
          <div class="relative flex-1">
            <input
              type="text"
              id="category-search"
              placeholder="Vyhledat v kategorii..."
              autocomplete="off"
              class="w-full px-4 py-2 md:py-3 bg-white rounded-lg border-2 border-transparent focus:border-[#00A44F] focus:outline-none text-base md:text-lg font-body transition-colors"
              aria-haspopup="listbox"
              aria-expanded="false"
              aria-controls="category-search-autocomplete"
            />
            
            <!-- Autocomplete Dropdown -->
            <div
              id="category-search-autocomplete"
              role="listbox"
              class="hidden absolute z-50 w-full mt-2 bg-white border-2 border-gray-200 rounded-lg shadow-xl max-h-96 overflow-y-auto left-0"
              aria-label="Návrhy produktů"
            >
              <!-- Suggestions injected by JS -->
            </div>
            
            <!-- No Autocomplete Results -->
            <div id="category-search-no-autocomplete" class="hidden absolute z-50 w-full mt-2 bg-white border-2 border-gray-200 rounded-lg shadow-lg px-4 py-3 left-0">
              <p class="text-gray-600 text-sm md:text-base font-body">Žádné produkty nenalezeny</p>
            </div>
          </div>
          
          <!-- Search Button -->
          <button
            type="button"
            id="category-search-button"
            class="flex-shrink-0 px-6 md:px-8 py-2 md:py-3 bg-[#00A44F] hover:bg-green-700 text-white font-semibold rounded-lg transition-colors text-base md:text-lg font-body"
          >
            Vyhledat
          </button>
        </div>
      </div>
    </div>
    
    <!-- Search Results Header (hidden by default) -->
    <div id="category-search-results-header" class="hidden mb-6">
      <h2 class="text-xl md:text-2xl lg:text-3xl font-bold mb-4 font-heading">
        Vyhledávání v kategorii {{ name }}: "<span id="category-search-query-display"></span>"
      </h2>
    </div>

    <!-- Collect all unique labels from products in this category -->
    {% set allLabels = [] %}
      {% for product in categoryProducts %}
        {% if product.data.labels %}
          {% for label in product.data.labels %}
            {% set labelText = label.label if label.label else label %}
            {% if labelText and allLabels.indexOf(labelText) == -1 %}
              {% set allLabels = allLabels.concat([labelText]) %}
            {% endif %}
          {% endfor %}
        {% endif %}
      {% endfor %}

      <!-- Label Filters -->
      {% if allLabels.length > 0 %}
        <div class="mb-8" id="category-label-filters">
          <!-- Filter Toggle Header -->
          <div class="flex items-center justify-start mb-4">
            <span class="text-lg md:text-2xl font-semibold font-heading px-3">Filtry:</span>
            <button 
              id="filterToggleBtn" 
              type="button"
              class="filter-toggle-btn flex items-center justify-center w-10 h-10 md:w-12 md:h-12 bg-[#00A44F] hover:bg-[#008f43] text-white rounded-lg transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-[#00A44F] focus:ring-offset-2"
              aria-expanded="false"
              aria-controls="filterPanel"
              aria-label="Zobrazit filtry"
              title="Zobrazit/skrýt filtry"
            >
              <!-- Filter Icon SVG -->
              <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
              </svg>
            </button>
          </div>
          
          <!-- Collapsible Filter Panel -->
          <div 
            id="filterPanel" 
            class="filter-panel"
            role="region"
            aria-labelledby="filterToggleBtn"
          >
            <div class="flex flex-wrap gap-3">
              <!-- Clear All Filter -->
              <button id="clearFilters" class="filter-tag active px-4 py-2 bg-[#00A44F] text-white rounded-full text-sm font-medium transition-colors hover:bg-green-700">
                Vše
              </button>
              
              <!-- Label Filter Tags -->
              {% for label in allLabels %}
                <button class="filter-tag px-4 py-2 bg-white border-2 border-[#00A44F] text-[#00A44F] rounded-full text-sm font-medium transition-colors hover:bg-[#00A44F] hover:text-white" data-label="{{ label }}">
                  #{{ label }}
                </button>
              {% endfor %}
            </div>
          </div>
        </div>
      {% endif %}

      <!-- Products Grid -->
      <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3 mb-8" id="products-container" data-category-products="{{ name }}">
        {% for p in categoryProducts %}
          {% set productLabels = [] %}
          {% if p.data.labels %}
            {% for label in p.data.labels %}
              {% set labelText = label.label if label.label else label %}
              {% set productLabels = productLabels.concat([labelText]) %}
            {% endfor %}
          {% endif %}
          <div class="product-item" 
               data-labels="{{ productLabels | join(',') }}"
               data-product-title="{{ p.data.title | lower }}"
               data-product-url="{{ p.url }}">
            {% include "components/product-card.njk" %}
          </div>
        {% endfor %}
      </div>
      
      <!-- Results Counter -->
      <div class="text-center">
        <p id="resultsCounter" class="text-lg text-gray-700">V kategorii se nachází {{ categoryProducts | length }} položek.</p>
      </div>
    {% else %}
      <div class="text-center py-12">
        <p class="text-xl text-gray-600">V této kategorii zatím nejsou žádné produkty.</p>
      </div>
    {% endif %}
  </div>
</section>

<!-- Filter Toggle Script -->
<script src="/assets/js/filter-toggle.js"></script>

<!-- Label Filters Script -->
<script src="/assets/js/label-filters.js"></script>

<!-- Category Search Script -->
<script src="/assets/js/category-search.js"></script>
{% endblock %}